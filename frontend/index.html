<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–°–∫–∞–Ω–µ—Ä –∫–æ—Å–º–µ—Ç–∏—á–Ω–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
  </head>
  <body>
    <h1>–°–∫–∞–Ω–µ—Ä –∫–æ—Å–º–µ—Ç–∏—á–Ω–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤</h1>

    <form id="upload-form">
      <input type="file" id="image" accept="image/*" required />
      <button type="submit">–ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏</button>
    </form>

    <div class="result" id="result"></div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É —É PDF -->
    <div class="button-container">
      <button id="download-pdf">–ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ PDF</button>
    </div>

    <script>
      const form = document.getElementById("upload-form");
      const resultDiv = document.getElementById("result");
      let results = [];

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        resultDiv.innerHTML = "<p>‚è≥ –ê–Ω–∞–ª—ñ–∑—É—î–º–æ...</p>";

        const formData = new FormData();
        const file = document.getElementById("image").files[0];
        formData.append("image", file);

        try {
          const response = await fetch("http://127.0.0.1:5000/analyze", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (data.status === "success") {
            let html = `<h3>üîç –†–æ–∑–ø—ñ–∑–Ω–∞–Ω–∏–π —Ç–µ–∫—Å—Ç:</h3><div>${data.text}</div>`;

            if (data.ingredients.length === 0) {
              html +=
                '<p class="safe">‚úÖ –®–∫—ñ–¥–ª–∏–≤–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>';
            } else {
              html += "<h3>‚ö†Ô∏è –í–∏—è–≤–ª–µ–Ω—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏:</h3>";
              results = data.ingredients; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É PDF
              data.ingredients.forEach((ing) => {
                let className = "";
                if (ing.risk === "High") className = "danger";
                else if (ing.risk === "Medium") className = "neutral";
                else if (ing.risk === "Safe") className = "safe";

                html += `<div class="${className}">
            <strong>${ing.name}</strong><br>
            –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${ing.category || "–ù–µ–≤—ñ–¥–æ–º–æ"}<br>
            –†–∏–∑–∏–∫: ${ing.risk}<br>
            ${ing.description}
          </div>`;
              });
            }

            resultDiv.innerHTML = html;
          } else {
            resultDiv.innerHTML =
              '<p class="danger">üö´ –ü–æ–º–∏–ª–∫–∞: ' + data.message + "</p>";
          }
        } catch (err) {
          resultDiv.innerHTML =
            '<p class="danger">üö´ –ù–µ –≤–¥–∞–ª–æ—Å—è –∑\'—î–¥–Ω–∞—Ç–∏—Å—å –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.</p>';
          console.error(err);
        }
      });

      // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É —è–∫ PDF
      const downloadPdfButton = document.getElementById("download-pdf");
      downloadPdfButton.addEventListener("click", async () => {
        const response = await fetch("http://127.0.0.1:5000/download_pdf", {
          method: "POST",
          body: JSON.stringify({
            text: document.querySelector("#result .text").innerText, // –û—Ç—Ä–∏–º—É—î–º–æ —Ç–µ–∫—Å—Ç
            ingredients: results, // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–Ω–∞–π–¥–µ–Ω—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏
          }),
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (response.status === 200) {
          const blob = await response.blob();
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "results.pdf";
          link.click();
        }
      });
    </script>
  </body>
</html>
